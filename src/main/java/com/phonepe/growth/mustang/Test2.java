package com.phonepe.growth.mustang;

import java.io.IOException;
import java.util.Set;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.phonepe.growth.mustang.common.RequestContext;
import com.phonepe.growth.mustang.criteria.Criteria;
import com.phonepe.growth.mustang.ratify.RatificationResult;

public class Test2 {
    public static void main(String[] args) throws IOException {

        ObjectMapper mapper = new ObjectMapper();
        MustangEngine engine = MustangEngine.builder()
                .mapper(mapper)
                .build();

        String criteria = "{ \"form\": \"DNF\", \"id\": \"OF2109161726516463823108\", \"conjunctions\": [{ \"type\": \"AND\", \"predicates\": [{ \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.causedEvent\", \"values\": [ \"FULFILL_SUCCESS\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.state\", \"values\": [ \"COMPLETED\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventType\", \"values\": [ \"RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.fulfillmentType\", \"values\": [ \"PREPAID_RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.app\", \"values\": [ \"nexus\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.operator\", \"values\": [ \"AIRTELPRE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.ref.resolvedPaths.amount\", \"values\": [ 4800, 24800, 8900, 7800, 9800, 11900, 13100, 25100 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.yoda.data_pack_ipl_21_2.value\", \"values\": [ 3 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false } ] }, { \"type\": \"AND\", \"predicates\": [{ \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.causedEvent\", \"values\": [ \"FULFILL_SUCCESS\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.state\", \"values\": [ \"COMPLETED\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventType\", \"values\": [ \"RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.fulfillmentType\", \"values\": [ \"PREPAID_RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.app\", \"values\": [ \"nexus\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.operator\", \"values\": [ \"JIO\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.ref.resolvedPaths.amount\", \"values\": [ 64800, 2100, 10100, 20100, 54900, 1100, 5100, 15100, 25100 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.yoda.data_pack_ipl_21_2.value\", \"values\": [ 3 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false } ] }, { \"type\": \"AND\", \"predicates\": [{ \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.causedEvent\", \"values\": [ \"FULFILL_SUCCESS\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.state\", \"values\": [ \"COMPLETED\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventType\", \"values\": [ \"RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.fulfillmentType\", \"values\": [ \"PREPAID_RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.app\", \"values\": [ \"nexus\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.operator\", \"values\": [ \"VILPRE\", \"IDM\", \"VOD\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.ref.resolvedPaths.amount\", \"values\": [ 1600, 4800, 50100, 9800, 5100, 25100, 35100, 35500 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.yoda.data_pack_ipl_21_2.value\", \"values\": [ 3 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false } ] }, { \"type\": \"AND\", \"predicates\": [{ \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.causedEvent\", \"values\": [ \"FULFILL_SUCCESS\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.state\", \"values\": [ \"COMPLETED\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventType\", \"values\": [ \"RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.fulfillmentType\", \"values\": [ \"PREPAID_RECHARGE\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.app\", \"values\": [ \"nexus\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.operator\", \"values\": [ \"BSP\" ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.ref.resolvedPaths.amount\", \"values\": [ 1600, 5600, 3300, 5700, 24100, 149800, 1900, 2700, 25100, 6800, 1300, 2900, 59700, 119700, 19800, 3100, 15100 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false }, { \"type\": \"INCLUDED\", \"lhs\": \"$.eventData.yoda.data_pack_ipl_21_2.value\", \"values\": [ 3 ], \"lhsNotAPath\": false, \"weight\": 0, \"defaultResult\": false } ] } ]}";
        Criteria c1 = mapper.readValue(criteria, Criteria.class);

        String str = "{ \"app\": \"nexus\", \"eventType\": \"RECHARGE\", \"id\": \"786af97c-2c36-4025-9826-2976fd492325\", \"groupingKey\": \"U2010311045206898183239\", \"partitionKey\": null, \"eventSchemaVersion\": \"v13\", \"time\": 1631990272343, \"eventData\": { \"yoda\": { \"userRechargeOperatorSplitMonthly\": { \"key\": \"U2010311045206898183239|PREPAID_RECHARGE|JIO\", \"value\": 3 }, \"userNexusTypeSplitMonthly\": { \"key\": \"U2010311045206898183239|PREPAID_RECHARGE\", \"value\": 4 }, \"userPrepaidRechargeNumbersMonthly\": { \"key\": \"PREPAID_RECHARGE|U2010311045206898183239\", \"value\": 4 }, \"userRechargeOperatorSplit\": { \"key\": \"U2010311045206898183239|PREPAID_RECHARGE|JIO\", \"value\": 10 }, \"userNexusTypeSplit\": { \"key\": \"U2010311045206898183239|PREPAID_RECHARGE\", \"value\": 13 }, \"data_pack_ipl_21_2\": { \"key\": \"data_pack_ipl_21_2|U2010311045206898183239\", \"value\": 3 }, \"walletDebitsAmountDaily\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"userMinAmt500P2PTxnReceiverDetailsWeekly\": { \"key\": \"P2P_RECEIVER_ALL|U2010311045206898183239\", \"value\": 0 }, \"merchantWalletPaymentMonthlyAmount\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"merchantWalletPaymentHourlyCount\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"giftCardAmountUserMonthly\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"digiGoldWalletCntMonthly\": { \"key\": \"WALLET_MONTHLY_CNT|U2010311045206898183239\", \"value\": 0 }, \"userMinAmt500P2PTxnDetailsMonthly\": { \"key\": \"P2P_ALL|U2010311045206898183239\", \"value\": 0 }, \"uniqueUsersToStoresOfflineTransactionsCounts\": { \"key\": \"USER_TO_STORES_TRANSACTIONS|U2010311045206898183239\", \"value\": 2 }, \"merchantWalletPaymentDailyCount\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"walletDebitsDaily\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"userMinAmt101P2PTxnDetailsDaily\": { \"key\": \"P2P_ALL|U2010311045206898183239\", \"value\": 0 }, \"userAppPaymentCount\": { \"key\": \"U2010311045206898183239\", \"value\": 35 }, \"giftCardAmountUserWeekly\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"userMinAmt100P2PTxnCntDaily\": { \"key\": \"P2P_TXN_AMT_GT_100|U2010311045206898183239\", \"value\": 0 }, \"uniqueUsersToStoresOfflineTransactions\": { \"key\": \"USER_TO_STORES|U2010311045206898183239\", \"value\": 2 }, \"userMinAmt500P2PTxnCntDaily\": { \"key\": \"P2P_TXN_AMT_GT_500|U2010311045206898183239\", \"value\": 0 }, \"userMinAmt500P2PTxnReceiverDetailsMonthly\": { \"key\": \"P2P_RECEIVER_ALL|U2010311045206898183239\", \"value\": 0 }, \"ioclTransactingConsumerCount\": { \"key\": \"IOCL_CONSUMER|U2010311045206898183239\", \"value\": 1 }, \"userTransactionCountGT20\": { \"key\": \"USER_TXN_COUNT_GT20|U2010311045206898183239\", \"value\": 2 }, \"merchantWalletPaymentMonthlyCount\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"userMinAmtP2PTxnDistinctSha500DetailsDaily\": { \"key\": \"P2P_ALL|MIN_500|U2010311045206898183239\", \"value\": 0 }, \"userMinAmt500P2PTxnDetailsWeekly\": { \"key\": \"P2P_ALL|U2010311045206898183239\", \"value\": 0 }, \"userMinAmt100P2PTxnReceiversDaily\": { \"key\": \"P2P_ALL_RECEIVERS|U2010311045206898183239\", \"value\": 0 }, \"userUPIPayCount\": { \"key\": \"UPI_ALL|U2010311045206898183239\", \"value\": 35 }, \"userScratchCardGrantCount\": { \"key\": \"ALL|U2010311045206898183239\", \"value\": 42 }, \"userP2PUPISendCountInternal\": { \"key\": \"P2P_INTERNAL|U2010311045206898183239\", \"value\": 20 }, \"giftCardPurchasesUserWeekly\": { \"key\": \"GCU|U2010311045206898183239\", \"value\": 0 }, \"userP2PUPISendCount\": { \"key\": \"P2P_ALL|U2010311045206898183239\", \"value\": 20 }, \"offlineMerchantTransactionsCountForAUser\": { \"key\": \"USER_OFFLINE_TRANSACTION_COUNT|U2010311045206898183239\", \"value\": 2 }, \"digiGoldWalletAmtMonthly\": { \"key\": \"WALLET_MONTHLY|U2010311045206898183239\", \"value\": 0 }, \"overallOfflinePhonePeMerchantTransactionsCountForAUser\": { \"key\": \"USER_OFFLINE_PHONEPE_TRANSACTION_COUNT|U2010311045206898183239\", \"value\": 2 }, \"walletDebitsAmountHourly\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"userMinAmt500P2PTxnDistinctReceiverDaily\": { \"key\": \"P2P_RECEIVER_ALL|MIN_500|U2010311045206898183239\", \"value\": 0 }, \"userScratchCardBenefitHistory\": { \"key\": \"LAST_BENEFITS|U2010311045206898183239\", \"value\": [ \"COUPON\", \"OFFER\", \"COUPON\", \"COUPON\", \"OFFER\", \"COUPON\", \"COUPON\", \"COUPON\", \"COUPON\", \"COUPON\" ] }, \"userMinAmtP2PTxnDetailsWeekly\": { \"key\": \"P2P_ALL|U2010311045206898183239\", \"value\": 0 }, \"userTxnCount\": { \"key\": \"ALL|U2010311045206898183239\", \"value\": 35 }, \"userMinAmt101P2PTxnReceiversDaily\": { \"key\": \"P2P_ALL_RECEIVERS|U2010311045206898183239\", \"value\": 0 }, \"giftCardAmountUserDaily\": { \"key\": \"U2010311045206898183239\", \"value\": 0 }, \"userMinAmtP2PTxnDetailsDaily\": { \"key\": \"P2P_ALL|U2010311045206898183239\", \"value\": 0 }, \"offlineMerchantTransactionsCountForAUserInOfferPeriod\": { \"key\": \"USER_OFFLINE_TRANSACTION_COUNT|U2010311045206898183239\", \"value\": 2 }, \"giftCardPurchasesUserDaily\": { \"key\": \"GCU|U2010311045206898183239\", \"value\": 0 }, \"userPrepaidRechargeNumbersMonthly_DEBUG\": { \"key\": \"PREPAID_RECHARGE|U2010311045206898183239\", \"value\": { \"set_N\": [ \"9763851433\", \"7499170471\", \"9359721595\", \"8080193500\" ] } } }, \"referenceId\": \"NX21091900074683639285801\", \"createdAt\": 1631990270000, \"userId\": \"U2010311045206898183239\", \"contactId\": \"8080193500\", \"state\": \"COMPLETED\", \"source\": \"PHN\", \"amount\": 1100, \"paymentReference\": \"T2109190007468434859452\", \"causedEvent\": \"FULFILL_SUCCESS\", \"paymentMode\": \"ACCOUNT\", \"description\": \"RECHARGE_SUCCESSFUL\", \"serviceProvider\": \"EURONET\", \"providerReference\": \"6595608785\", \"operatorReference\": \"11230062728\", \"fulfillmentType\": \"PREPAID_RECHARGE\", \"metaData\": { \"deviceFingerprint\": \"3faec520-6070-4521-8922-3eb37727c354UUNfUmVmZXJlbmNlX1Bob25l-cWNvbQ-\", \"deviceLatitude\": 18.5213, \"deviceLongitude\": 73.8523, \"deviceCapability\": \"capability\", \"deviceManufacturer\": \"Xiaomi\", \"deviceIp\": \"157.33.102.27\", \"deviceAdvertiserId\": \"3FAEC5206070452189223EB37727C354UUN\", \"deviceOS\": \"Android\", \"deviceOSVersion\": \"29\", \"deviceBuildVersion\": \"Xiaomi/olive/olive:10/QKQ1.191014.001/V12.0.2.0.QCNINXM:user/release-keys\", \"deviceType\": \"Mobile\", \"requestSourceType\": \"APP\", \"requestSourcePlatform\": \"Android\" }, \"duration\": { \"seconds\": 2, \"minutes\": 0, \"hours\": 0, \"days\": 0 }, \"requestInfo\": { \"requestTime\": 1631990269732, \"deviceFingerprint\": \"3faec520-6070-4521-8922-3eb37727c354UUNfUmVmZXJlbmNlX1Bob25l-cWNvbQ-\", \"ip\": \"157.33.102.27\", \"requestId\": \"16c87b49-d6c3-4ead-a8f7-255116c2d2b4\", \"maxMindInfo\": { \"anonymousIp\": false, \"anonymousVpn\": false, \"tor\": false, \"city\": \"UNKNOWN\", \"state\": \"UNKNOWN\", \"stateIso\": \"UNKNOWN\", \"country\": \"UNKNOWN\", \"countryIso\": \"UNKNOWN\", \"postal\": \"UNKNOWN\", \"userType\": \"UNKNOWN\", \"connectionType\": \"UNKNOWN\", \"isp\": \"UNKNOWN\", \"latitude\": 18.5213, \"longitude\": 73.8523, \"accuracy\": 0 }, \"authorizationSubject\": \"3faec520-6070-4521-8922-3eb37727c354UUNfUmVmZXJlbmNlX1Bob25l-cWNvbQ-:U2010311045206898183239:fdab17054b934ee28271230cb743d3a7\", \"authorizeForId\": \"U2010311045206898183239\", \"firstPartyMerchant\": false, \"sourcePlatform\": \"Android\", \"sourceVersion\": \"400936\", \"sourceSdkVersionInfo\": {}, \"decryptedRequest\": false, \"sourceLocale\": \"en\", \"serviceProviderInfo\": {} }, \"circle\": \"MHG\", \"operator\": \"JIO\", \"productType\": \"MOBILE\", \"rechargeType\": \"Default\", \"planType\": { \"displayName\": \"Data Addon\", \"id\": \"DATA_ADDON\", \"paginationType\": \"page\", \"sequence\": 18, \"customPlanCategory\": false, \"isMailBox\": false }, \"planSubType\": \"Others\", \"planValidity\": \"NA\", \"convenienceFee\": 0 }, \"ingestionTime\": 1631990272372, \"yatraMeta\": [], \"systemTimeMeta\": { \"systemDate\": \"2021-09-19\", \"systemTime\": \"19:20:35\" }, \"eventTimeMeta\": { \"eventDate\": \"2021-09-19\", \"eventTime\": \"00:07:50\", \"eventHour\": 0, \"eventDayOfWeek\": 7, \"eventDayOfMonth\": 19, \"eventDayOfYear\": 262, \"eventWeekOfMonth\": 3, \"eventWeekOfYear\": 37, \"eventMonth\": 9 }, \"ref\": { \"resolvedPaths\": { \"user\": \"U2010311045206898183239\", \"order\": \"NX21091900074683639285801\", \"deviceFP\": \"3faec520-6070-4521-8922-3eb37727c354UUNfUmVmZXJlbmNlX1Bob25l-cWNvbQ-\", \"transaction\": \"T2109190007468434859452\", \"globalPayment\": \"NX21091900074683639285801\", \"category\": \"PREPAID_RECHARGE\", \"operator\": \"JIO\", \"amount\": 1100, \"offer\": \"OF2109161726516463823108\" }, \"event\": { \"paymentInfo\": [{ \"type\": \"ACCOUNT\", \"transactionState\": \"COMPLETED\", \"transactionResponseCode\": \"00\", \"flags\": 0, \"amount\": 1100, \"actualAmount\": 1100, \"accountId\": \"A2106061501103903761163\", \"accountNumber\": \"0351XXXX6371\", \"accountHolderName\": \"ROHIT SATISH HIRULAKAR\", \"ifsc\": \"IPOS0000001\", \"utr\": \"126237403655\", \"vpa\": \"9325362903@ybl\", \"accountAuthMode\": \"UPI\", \"accountSha\": \"4e6322477981f5480d322d2430bb1880dc0385e447c20b07d41b6c885f33da6f\", \"accountType\": \"SAVINGS\" }], \"scratchCardV2CompatibleVersionCheck\": true, \"offerBenefit\": true }, \"validity\": { \"scratchCardV2CompatibleVersionCheck\": true, \"offerBenefit\": true } }}";
        engine.add("test", c1);
        final RequestContext context = RequestContext.builder()
                .node(mapper.readTree(str))
                .build();
        long start = System.currentTimeMillis();
        final Set<String> searchResults = engine.search("test", context, false);
        System.out.println(searchResults);
        System.out.println(System.currentTimeMillis() - start);

        engine.ratify("test", false);
        final RatificationResult ratificationResult = engine.getRatificationResult("test");

        System.out.println(ratificationResult);

    }

}
